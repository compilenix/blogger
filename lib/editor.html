<!DOCTYPE html>
<head>
    <meta charset="UTF-8"/>
    <meta name="author" content="{{Author}}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="{{StaticContent_jquery.js}}"></script>
    <script type="text/javascript" src="{{StaticContent_ace.js}}"></script>
    <script type="text/javascript" src="{{StaticContent_worker-html.js}}"></script>
    <script type="text/javascript" src="{{StaticContent_mode-html.js}}"></script>
    <script type="text/javascript" src="{{StaticContent_theme-monokai.js}}"></script>

    <title>{{Title}}</title>

    <style>
        @font-face {
            font-family: Ubuntu;
            src: url("{{StaticContent_Ubuntu-R}}") format("truetype");
        }

        @font-face {
            font-family: Ubuntu;
            font-weight: bold;
            src: url("{{StaticContent_Ubuntu-B}}") format("truetype");
        }

        a { text-decoration: none; }

        a:hover, a:focus { color: #0AF; }

        #menu {
            font-family: Ubuntu, Tahoma, Verdana, sans-serif, serif;
            font-size: 1em;
            height: 30px;
            left: 0;
            line-height: 1.2em;
            padding-top: 5px;
            position: absolute;
            right: 0;
            top: 0;
        }

        #menu * {
            cursor: pointer;
            margin: 5px;
        }

        #tabs {
            background-color: #161713;
            font-family: Ubuntu, Tahoma, Verdana, sans-serif, serif;
            font-size: 1em;
            height: 30px;
            left: 20%;
            line-height: 1.2em;
            padding-left: 50px;
            position: absolute;
            right: 0;
            top: 30px;
        }

        #tabs > div {
            background-image: url({{StaticContent_inactivel.png}});
            background-position: left, right;
            background-repeat: no-repeat, no-repeat;
            color: #c1c1bf;
            cursor: default;
            display: inline;
            float: left;
            height: 31px;
            margin-right: -12px;
            padding-left: 19px;
            padding-right: 19px;
            padding-top: 3px;
            position: relative;
            z-index: 1;
        }

        #tabs > div > div {
            background-image: url({{StaticContent_inactivec.png}});
            background-repeat: repeat-x;
            height: 31px;
        }

        #tabs > div.active > div {
            background-image: url({{StaticContent_activec.png}});
            background-repeat: repeat-x;
        }

        #tabs > div > div > div.wrapper {
            padding-right: 20px;
            padding-top: 5px;
            position: relative;
        }

        #tabs div.button {
            background-image: url({{StaticContent_inactiveclose.png}});
            height: 8px;
            position: absolute;
            right: 3px;
            top: 10px;
            width: 7px;
        }

        #tabs > div.active div.button { background-image: url({{StaticContent_activeclose.png}}); }

        #tabs > div.changed { color: #ffa035; }

        #tabs > div.active {
            background-image: url({{StaticContent_activel.png}}), url({{StaticContent_activer.png}});
            z-index: 2;
        }

        #edit {
            bottom: 0;
            font-family: Lucida, Consolas, Courier, Verdana;
            font-size: 1em;
            left: 20%;
            line-height: 1.2em;
            position: absolute;
            right: 0;
            top: 60px;
        }

        #postlist {
            background-color: #e6e6e6;
            bottom: 0;
            cursor: default;
            font-family: Ubuntu, Tahoma, Verdana, sans-serif, serif;
            font-size: 1em;
            left: 0;
            line-height: 1.2em;
            position: absolute;
            right: 80%;
            top: 30px;
        }

        #postlist ul { list-style-type: none; }

        #postlist li {
            background-image: url({{StaticContent_doc.png}});
            background-position: left center;
            background-repeat: no-repeat;
            margin: 4px;
            padding-left: 15px;
        }
    </style>
</head>

<body>
<div id="menu">
    <label onclick="e.emptyTab();">New</label>
    <label onclick="e.remove();">Remove</label>
    <label onclick="e.preview();">Preview</label>
</div>
<div id="postlist"></div>
<div id="tabs"></div>
<div id="edit"></div>
<script type="text/javascript">
    "use strict";

    function editor() {
        this.postlistContainer = document.getElementById('postlist');
        this.editorContainer = document.getElementById('edit');
        this.tabsContainer = document.getElementById('tabs');
        this.ace = ace.edit("edit");
        this.ace.setTheme("ace/theme/monokai");
        this.ace.getSession().setMode("ace/mode/html");

        this.apikey = this.loadApiKey();
        this.title = "";

        if (!this.apikey) {
            this.askForKey();
        }

        this.requestPostlist();

        this.sessions = {};

        this.sessions['default'] = this.ace.getSession();

        this.sessions['default'].on('change', function(ev) {
            if (ev.data.action === 'insertText') {
                const name = Math.floor(new Date().getTime() / 1000).toString(16);
                e.newSession(name, ev.data.text, true);
                e.ace.navigateFileEnd();
                e.sessions['default'].setValue('');
            }
        });
        document.addEventListener('keydown', function(event) {
            if (event.keyCode === 83 && event.ctrlKey) {
                if ($('#tabs div.active')[0]) {
                    e.save($($('#tabs div.active')[0]).attr('data-postid'));
                }
            } else if (event.keyCode === 78 && event.ctrlKey) {
                const name = Math.floor(new Date().getTime() / 1000).toString(16);
                e.newSession(name, '', true);
            } else {
                return true;
            }
            event.preventDefault();
            return false;
        });

    }

    editor.prototype.request = function(post) {
        jQuery.post('/ajax/', post, function(data) {
            e.handleResponse(data);
        }, 'json').fail(function(d) {
            e.askForKey();
        });
    };
    editor.prototype.handleResponse = function(data) {
        if (data.type) {
            switch (data.type) {
                case 'postlist':
                    this.updatePostList(data);
                    break;
                case 'post':
                    this.loadPost(data);
                    break;
                case 'postsaved':
                    this.postSaved(data.id);
                    break;
                case 'postremoved':
                    this.postRemoved(data.id);
                    break;
                default:
                    alert('unknown response type');
                    break;
            }
        }
    };
    editor.prototype.askForKey = function() {
        const key = prompt('please enter your apy key');
        this.apikey = key;
        this.storeApiKey(key);
    };
    editor.prototype.loadApiKey = function() {
        return localStorage.apikey;
    };
    editor.prototype.storeApiKey = function(apikey) {
        localStorage.setItem('apikey', apikey);
    };
    editor.prototype.loadPost = function(data) {
        console.log(data);
        this.newSession(data.id, data.content.contents, false, data.title);
        this.title = data.title;
    };
    editor.prototype.postSaved = function(id) {
        $(this.tabsContainer).find('div[data-postid=' + id + ']').removeClass('changed');
        this.requestPostlist();
        this.closeTab(id);
        this.showPost(id);
    };
    editor.prototype.updatePostList = function(data) {
        const ul = document.createElement('ul');
        for (let i = 0; i < data.list.length; i++) {
            const li = document.createElement('li');
            li.appendChild(document.createTextNode(data.titles[i]));
            li.setAttribute('data-postid', data.list[i]);
            jQuery(li).on('click', function(ev) {
                e.showPost(this.getAttribute('data-postid'));
            });
            ul.appendChild(li);
        }
        this.postlistContainer.innerHTML = '';
        this.postlistContainer.appendChild(ul);
    };
    editor.prototype.requestPostlist = function() {
        this.request({
            apikey: this.apikey,
            action: 'postlist'
        });
    };
    editor.prototype.requestPost = function(id) {
        this.request({
            apikey: this.apikey,
            postid: id,
            action: 'getpost'
        });
    };
    editor.prototype.requestSavePost = function(id, title, content) {
        this.title = title;
        this.request({
            apikey: this.apikey,
            postid: id,
            title: title,
            content: content,
            action: 'writepost'
        });
    };
    editor.prototype.save = function(id) {
        const title = prompt('Enter title:', this.title);
        if (id && title) {
            this.title = title;
            this.requestSavePost(id, title, this.ace.getValue());
        }
        return false;
    };
    editor.prototype.showPost = function(id) {
        if (this.hasSession(id)) {
            this.openSession(id);
        } else {
            this.requestPost(id);
        }
    };
    editor.prototype.emptyTab = function() {
        const name = Math.floor(new Date().getTime() / 1000).toString(16);
        e.newSession(name, '', true);
    };
    editor.prototype.remove = function() {
        if (!confirm('are you sure?')) {
            return false;
        }
        this.request({
            apikey: this.apikey,
            action: "removepost",
            postid: $('#tabs div.active').attr("data-postid")
        });
    };
    editor.prototype.postRemoved = function(id) {
        this.closeTab(id);
        this.requestPostlist();
    };
    editor.prototype.addTab = function(id, isnew, title) {
        const tab = document.createElement('div');
        const inner = document.createElement('div');
        const wrapper = document.createElement('div');
        const closebutton = document.createElement('div');
        closebutton.setAttribute('data-postid', id);
        $(closebutton).addClass('button');
        $(wrapper).addClass('wrapper');
        tab.setAttribute('data-postid', id);
        jQuery(tab).on('click', function(ev) {
            ev.preventDefault();
            e.openSession(this.getAttribute('data-postid'));
            return false;
        });
        jQuery(closebutton).on('click', function(ev) {
            ev.preventDefault();
            e.closeTab(this.getAttribute('data-postid'));
            return false;
        });
        wrapper.appendChild(document.createTextNode(isnew ? id + ' <new>' : title));
        wrapper.appendChild(closebutton);
        inner.appendChild(wrapper);
        tab.appendChild(inner);
        this.tabsContainer.appendChild(tab);
        this.title = title;
        return tab;
    };
    editor.prototype.closeTab = function(id) {
        if ($(this.tabsContainer).find('div[data-postid=' + id + ']').hasClass('changed')) {
            if (!confirm('are you sure?')) {
                return false;
            }
        }
        if ($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].previousSibling) {
            this.openSession($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].previousSibling.getAttribute('data-postid'));
        } else if ($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].nextSibling) {
            this.openSession($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].nextSibling.getAttribute('data-postid'));
        } else {
            this.ace.setSession(this.sessions['default']);
            this.ace.focus();
        }
        $(this.tabsContainer).find('div[data-postid=' + id + ']').remove();
        this.sessions[id] = false;
    };
    editor.prototype.activateTab = function(id) {
        $('#tabs div').removeClass('active');
        $(this.tabsContainer).find('div[data-postid=' + id + ']').addClass('active');
    };
    editor.prototype.hasSession = function(id) {
        return this.sessions[id];
    };
    editor.prototype.newSession = function(id, content, isnew, title) {
        var tab = this.addTab(id, isnew, title);
        this.sessions[id] = ace.createEditSession(content || '', "ace/mode/html");
        this.sessions[id].on('change', function(e) {
            $(tab).addClass('changed');
        });
        this.openSession(id);
    };
    editor.prototype.openSession = function(id) {
        this.activateTab(id);
        this.ace.setSession(this.sessions[id]);
        this.ace.focus();
    };
    editor.prototype.preview = function(content) {
        $.post("/ajax/", { apikey: e.apikey, action: "previewpost", content: JSON.stringify(e.ace.getValue()), title: this.title },
            function(data) {
                const win = window.open('about:blank');
                win.document.open();
                win.document.write(data);
                win.document.close();
            }
        );
    };
    window.e = new editor();
</script>
</body>