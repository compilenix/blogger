<!DOCTYPE html>
<head>
<meta charset="UTF-8"/>
<meta name="description" content="Compilenix's Blog"/>
<meta name="author" content="Compilenix"/>
<script type="text/javascript" src="//cdn.compilenix.org/ace-builds/src-min/ace.js"></script>
<script type="text/javascript" src="//cdn.compilenix.org/jquery.js"></script>

<title>Compilenix's Blog</title>

<style>
a {
	text-decoration: none;
}

a:hover, a:focus {
	color: #0AF;
}

#menu {
	position: absolute;
	top:0;
	left:0;
	right:0;
	height:30px;
	padding-top:5px;
}

#menu * {
	margin:5px;
	cursor: pointer;
}

#tabs {
	padding-left: 50px;
    position: absolute;
    top: 30px;
    right: 0;
    left: 20%;
    height: 30px;
    background-color: #161713;
}

#tabs > div {
	background-image: url(//cdn.compilenix.org/blogger/inactivel.png), url(//cdn.compilenix.org/blogger/inactiver.png);
	background-position: left, right;
	background-repeat: no-repeat, no-repeat;
	cursor:default;
	display:inline;
	position: relative;
	float:left;
	height: 31px;
	color:#c1c1bf;
	padding-left:19px;
	padding-right: 19px;
  	padding-top: 3px;
	margin-right:-12px;
	z-index: 1;
}

#tabs > div > div {
	height: 31px;
	background-image: url(//cdn.compilenix.org/blogger/inactivec.png);
	background-repeat: repeat-x;

}

#tabs > div.active > div {

	background-image: url(//cdn.compilenix.org/blogger/activec.png);
	background-repeat: repeat-x;

}

#tabs > div > div > div.wrapper {
	position: relative;
	padding-right:20px;
	padding-top: 5px;
}

#tabs div.button {
	position: absolute;
	right:3px;
	top: 10px;
	height: 8px;
	width: 7px;
	background-image: url(//cdn.compilenix.org/blogger/inactiveclose.png);
}

#tabs > div.active div.button {
	background-image: url(//cdn.compilenix.org/blogger/activeclose.png);
}

#tabs > div.changed {
	color: #ffa035;
}

#tabs > div.active {
	background-image: url(//cdn.compilenix.org/blogger/activel.png), url(//cdn.compilenix.org/blogger/activer.png);
	z-index: 2;
}

#edit {
    position: absolute;
    top: 60px;
    right: 0;
    bottom: 0;
    left: 20%;
}
#postlist {
	cursor:default;
    position: absolute;
    background-color: #e6e6e6;
    top: 30px;
    right: 80%;
    bottom: 0;
    left: 0;
}

#postlist ul {
		list-style-type:none;
}

#postlist li {
	background-image: url(//cdn.compilenix.org/blogger/doc.png);
	background-repeat: no-repeat;
	background-position: left center;
	padding-left: 15px;
	margin: 4px;
}

</style>
</head>

<body>
<div id="menu">
	<label  onclick="e.emptyTab();">New</label>
	<label onclick="e.preview();">Preview</label>
</div>
<div id="postlist"></div>
<div id="tabs"></div>
<div id='edit'></div>
<script type="text/javascript">

	function editor() {
		this.postlistContainer = document.getElementById('postlist');
		this.editorContainer = document.getElementById('edit');
		this.tabsContainer = document.getElementById('tabs');
		this.ace = ace.edit("edit");
		this.ace.setTheme("ace/theme/monokai");
		this.ace.getSession().setMode("ace/mode/html");

		this.apikey = this.loadApiKey();

		if (!this.apikey) {
			this.askForKey();
		}

		this.requestPostlist();

		this.sessions = {};

		this.sessions['default'] = this.ace.getSession();

		this.sessions['default'].on('change', function(ev) {
			if (ev.data.action == 'insertText') {
				var name = Math.floor(new Date().getTime() / 1000).toString(16);
				e.newSession(name, ev.data.text, true);
				e.ace.navigateFileEnd();
				e.sessions['default'].setValue('');
			}
		})

		document.addEventListener('keydown', function(event) {
			if (event.keyCode == 83 && event.ctrlKey) {
			    if ($('#tabs div.active')[0]) {
			    	e.save($($('#tabs div.active')[0]).attr('data-postid'));
			    }
			} else if (event.keyCode == 78 && event.ctrlKey) {
				var name = Math.floor(new Date().getTime() / 1000).toString(16);
			    e.newSession(name, '', true);
			} else {
				return true;
			}
		    event.preventDefault();
		    return false;
		});

	}

	editor.prototype.request = function(post) {
		jQuery.post('/ajax/', post, function(data) {
			e.handleResponse(data);
		}, 'json').fail(function(d) {
			e.askForKey();
		});
	}

	editor.prototype.handleResponse = function(data) {
		if (data.type) {
			switch (data.type) {
				case 'postlist':
					this.updatePostList(data);
					break;
				case 'post':
					this.loadPost(data);
					break;
				case 'postsaved':
					this.postSaved(data.id);
					break;
				default:
					alert('unknown response type')
					break;
			}
		}
	}

	editor.prototype.askForKey = function() {
		var key = prompt('please enter your apy key');
		this.apikey = key;
		this.storeApiKey(key);
	}

	editor.prototype.loadApiKey = function() {
		return localStorage.apikey;
	}

	editor.prototype.storeApiKey = function(apikey) {
		localStorage.setItem('apikey', apikey);
	}

	editor.prototype.loadPost = function(data) {
		console.log(data);
		this.newSession(data.id, data.content.contents, false, data.title);
	}

	editor.prototype.postSaved = function(id) {
		$(this.tabsContainer).find('div[data-postid=' + id + ']').removeClass('changed');
		this.requestPostlist();
		this.closeTab(id);
		this.showPost(id);
	}

	editor.prototype.updatePostList = function(data) {
		var ul = document.createElement('ul');
		for (var i = 0; i < data.list.length; i++) {
			var li = document.createElement('li');
			li.appendChild(document.createTextNode(data.titles[i]));
			li.setAttribute('data-postid', data.list[i]);
			jQuery(li).on('click', function(ev) {
				e.showPost(this.getAttribute('data-postid'));
			});
			ul.appendChild(li);
		}
		this.postlistContainer.innerHTML = '';
		this.postlistContainer.appendChild(ul);
	}

	editor.prototype.requestPostlist = function() {
		this.request({
			apikey: this.apikey,
			action: 'postlist'
		});
	}

	editor.prototype.requestPost = function(id) {
		this.request({
			apikey: this.apikey,
			postid: id,
			action: 'getpost'
		});
	}

	editor.prototype.requestSavePost = function(id, title, content) {
		this.request({
			apikey: this.apikey,
			postid: id,
			title: title,
			content: content,
			action: 'writepost'
		});
	}

	editor.prototype.save = function(id) {
		var title = prompt('Enter title:', (this.ace.getValue()).substring(0, 39));
		if (id && title) {
			this.requestSavePost(id, title, this.ace.getValue());
		}
		return false;
	}

	editor.prototype.showPost = function(id) {
		if (this.hasSession(id)) {
			this.openSession(id);
		} else {
			this.requestPost(id);
		}
	}

	editor.prototype.emptyTab = function() {
		var name = Math.floor(new Date().getTime() / 1000).toString(16);
		e.newSession(name, '', true);
	}

	editor.prototype.addTab = function(id, isnew, title) {
		var tab = document.createElement('div');
		var inner = document.createElement('div');
		var wrapper = document.createElement('div');
		var closebutton = document.createElement('div');
		closebutton.setAttribute('data-postid', id);
		$(closebutton).addClass('button');
		$(wrapper).addClass('wrapper');
		tab.setAttribute('data-postid', id);
		jQuery(tab).on('click', function(ev) {
			ev.preventDefault();
			e.openSession(this.getAttribute('data-postid'));
			return false;
		});
		jQuery(closebutton).on('click', function(ev) {
			ev.preventDefault();
			e.closeTab(this.getAttribute('data-postid'));
			return false;
		});
		wrapper.appendChild(document.createTextNode(isnew ? id + ' <new>': title));
		wrapper.appendChild(closebutton);
		inner.appendChild(wrapper);
		tab.appendChild(inner);
		this.tabsContainer.appendChild(tab);
		return tab;
	}

	editor.prototype.closeTab = function(id) {
		if ($(this.tabsContainer).find('div[data-postid=' + id + ']').hasClass('changed')) {
			if (!confirm('are you sure?')) {
				return false;
			}
		}
		if ($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].previousSibling) {
			this.openSession($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].previousSibling.getAttribute('data-postid'));
		} else if ($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].nextSibling) {
			this.openSession($(this.tabsContainer).find('div[data-postid=' + id + ']')[0].nextSibling.getAttribute('data-postid'));
		} else {
			this.ace.setSession(this.sessions['default']);
			this.ace.focus();
		}
		$(this.tabsContainer).find('div[data-postid=' + id + ']').remove();
		this.sessions[id] = false;
	}

	editor.prototype.activateTab = function(id) {
		$('#tabs div').removeClass('active');
		$(this.tabsContainer).find('div[data-postid=' + id + ']').addClass('active');
	}

	editor.prototype.hasSession = function(id) {
		return this.sessions[id];
	}

	editor.prototype.newSession = function(id, content, isnew, title) {
		var tab = this.addTab(id, isnew, title);
		this.sessions[id] = ace.createEditSession(content || '', "ace/mode/html");
		this.sessions[id].on('change', function(e) {
			$(tab).addClass('changed');
		})
		this.openSession(id);
	}

	editor.prototype.openSession = function(id) {
		this.activateTab(id);
		this.ace.setSession(this.sessions[id]);
		this.ace.focus();
	}

	editor.prototype.preview = function(content) {
		window.open("/ajax/?&action=previewpost&content=" + JSON.stringify(this.ace.getValue()));
	}

	window.e = new editor();

</script>
</body>
</html>
