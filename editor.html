<!DOCTYPE html>
<head>
<meta charset="UTF-8"/>
<meta name="description" content="Compilenix's Blog"/>
<meta name="author" content="Compilenix"/>
<script type="text/javascript" src="//cdn.compilenix.org/ace-builds/src-min/ace.js"></script>
<script type="text/javascript" src="//cdn.compilenix.org/jquery.js"></script>

<title>Compilenix's Blog</title>

<style>
a {
	text-decoration: none;
}

a:hover, a:focus {
	color: #0AF;
}

#tabs {
	padding-left: 50px;
    position: absolute;
    top: 0;
    right: 0;
    left: 20%;
    height: 30px;
    background-color: #161713;
}

#tabs div {
	cursor:default;
	display:inline;
	position: relative;
	float:left;
	height: 24px;
	color:#c1c1bf;
	padding-left:20px;
	padding-right:30px;
	padding-top: 5px;
	background-color: #3d3d3b;
	border: 1px solid #666664;
	border-bottom:0px;
	-webkit-border-top-left-radius: 30px;
	-webkit-border-top-right-radius: 30px;
	-moz-border-radius-topleft: 30px;
	-moz-border-radius-topright: 30px;
	border-top-left-radius: 30px;
	border-top-right-radius: 30px;
	margin-right:-10px;
	z-index: 1;

}

#tabs div.changed {
	color: #ffa035;
}

#tabs div.active {
	background-color: #272822;
	z-index: 2;
}

#edit {
    position: absolute;
    top: 30px;
    right: 0;
    bottom: 0;
    left: 20%;
}
#postlist {
	cursor:default;
    position: absolute;
    background-color: #e6e6e6;
    top: 0;
    right: 80%;
    bottom: 0;
    left: 0;
}
</style>
</head>

<body>
<div id="postlist"></div>
<div id="tabs"></div>
<div id='edit'></div>
<script type="text/javascript">

	function editor() {
		this.postlistContainer = document.getElementById('postlist');
		this.editorContainer = document.getElementById('edit');
		this.tabsContainer = document.getElementById('tabs');
		this.ace = ace.edit("edit");
		this.ace.setTheme("ace/theme/monokai");
		this.ace.getSession().setMode("ace/mode/html");

		this.apikey = this.loadApiKey();

		if (!this.apikey) {
			this.askForKey();
		}

		this.requestPostlist();

		this.sessions = {};

		document.addEventListener('keydown', function(event) {
			if (event.keyCode == 83 && event.ctrlKey) {
			    if ($('#tabs div.active')[0]) {
			    	e.save($($('#tabs div.active')[0]).attr('data-postid'));
			    }
			} else if (event.keyCode == 78 && event.ctrlKey) {
				var name = Math.floor(new Date().getTime() / 1000).toString(16);
			    e.newSession(name, '', true);
			} else {
				return true;
			}
		    event.preventDefault();
		    return false;
		});

	}

	editor.prototype.request = function(post) {
		jQuery.post('/ajax/', post, function(data) {
			e.handleResponse(data);
		}, 'json').fail(function(d) {
			e.askForKey();
		});
	}

	editor.prototype.handleResponse = function(data) {
		if (data.type) {
			switch (data.type) {
				case 'postlist':
					this.updatePostList(data.list);
					break;
				case 'post':
					this.loadPost(data);
					break;
				case 'postsaved':
					this.postSaved(data.id);
					break;
				default:
					alert('unknown response type')
					break;
			}
		}
	}

	editor.prototype.askForKey = function() {
		var key = prompt('please enter your apy key');
		this.apikey = key;
		this.storeApiKey(key);
	}

	editor.prototype.loadApiKey = function() {
		return localStorage.apikey;
	}

	editor.prototype.storeApiKey = function(apikey) {
		localStorage.setItem('apikey', apikey);
	}

	editor.prototype.loadPost = function(data) {
		this.newSession(data.id, data.content);
	}

	editor.prototype.postSaved = function(id) {
		$(this.tabsContainer).find('div[data-postid=' + id + ']').removeClass('changed');
		this.requestPostlist();
	}

	editor.prototype.updatePostList = function(data) {
		var ul = document.createElement('ul');
		for (var i = 0; i < data.length; i++) {
			var li = document.createElement('li');
			li.appendChild(document.createTextNode(data[i]));
			li.setAttribute('data-postid', data[i]);
			jQuery(li).on('click', function(ev) {
				e.showPost(this.getAttribute('data-postid'));
			});
			ul.appendChild(li);
		}
		this.postlistContainer.innerHTML = '';
		this.postlistContainer.appendChild(ul);
	}

	editor.prototype.requestPostlist = function() {
		this.request({
			apikey: this.apikey,
			action: 'postlist'
		});
	}

	editor.prototype.requestPost = function(id) {
		this.request({
			apikey: this.apikey,
			postid: id,
			action: 'getpost'
		});
	}

	editor.prototype.requestSavePost = function(id, content) {
		this.request({
			apikey: this.apikey,
			postid: id,
			content: content,
			action: 'writepost'
		});
	}

	editor.prototype.save = function(id) {
		id = prompt('Save as:', id);
		if (id) {
			this.requestSavePost(id, this.ace.getValue());
		}
	}

	editor.prototype.showPost = function(id) {
		if (this.hasSession(id)) {
			this.openSession(id);
		} else {
			this.requestPost(id);
		}
	}

	editor.prototype.addTab = function(id, isnew) {
		var tab = document.createElement('div');
		tab.setAttribute('data-postid', id);
		jQuery(tab).on('click', function() {
			e.openSession(this.getAttribute('data-postid'));
		});
		tab.appendChild(document.createTextNode(isnew ? id + ' <new>': id));
		this.tabsContainer.appendChild(tab);
		return tab;
	}

	editor.prototype.activateTab = function(id) {
		$('#tabs div').removeClass('active');
		$(this.tabsContainer).find('div[data-postid=' + id + ']').addClass('active');
	}

	editor.prototype.hasSession = function(id) {
		return typeof this.sessions[id] !== 'undefined';
	}

	editor.prototype.newSession = function(id, content, isnew) {
		var tab = this.addTab(id, isnew);
		this.sessions[id] = ace.createEditSession(content || '', "ace/mode/html");
		this.sessions[id].on('change', function(e) {
			$(tab).addClass('changed');
		})
		this.openSession(id);
	}

	editor.prototype.openSession = function(id) {
		this.activateTab(id);
		this.ace.setSession(this.sessions[id]);
		this.ace.focus();
	}

	window.e = new editor();
</script>
</body>
</html>
